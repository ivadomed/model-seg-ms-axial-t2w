
Compare our nnUNet models (`3d` and `2d`) with other methods (`sct_propseg`, `sct_deepseg_sc -kernel 2d`, 
`sct_deepseg_sc -kernel 3d`, `MONAI contrast-agnostic`) on `sci-zurich` and `sci-colorado` datasets.

## Data structure

Subjects from both datasets have to be located in the same BIDS-like folder, example:

```
├── derivatives
│	 └── labels
│	     ├── sub-5416     # sci-colorado subject
│	     │	 └── anat
│	     │	     ├── sub-5416_T2w_lesion-manual.json
│	     │	     ├── sub-5416_T2w_lesion-manual.nii.gz
│	     │	     ├── sub-5416_T2w_seg-manual.json
│	     │	     └── sub-5416_T2w_seg-manual.nii.gz
│	     └── sub-zh01     # sci-zurich subject
│	         └── ses-01
│	             └── anat
│	                 ├── sub-zh01_ses-01_acq-sag_T2w_lesion-manual.json
│	                 ├── sub-zh01_ses-01_acq-sag_T2w_lesion-manual.nii.gz
│	                 ├── sub-zh01_ses-01_acq-sag_T2w_seg-manual.json
│	                 └── sub-zh01_ses-01_acq-sag_T2w_seg-manual.nii.gz
├── sub-5416      # sci-colorado subject
│	 └── anat
│	     ├── sub-5416_T2w.json
│	     └── sub-5416_T2w.nii.gz
└── sub-zh01      # sci-zurich subject
 └── ses-01
     └── anat
         ├── sub-zh01_ses-01_acq-sag_T2w.json
         └── sub-zh01_ses-01_acq-sag_T2w.nii.gz
```

You can create this folder structure using the `create_combined_dataset_for_inference.sh` script:

```
create_combined_dataset_for_inference.sh <json_file> <zurich_folder> <colorado_folder> <output_folder>
```

## Dependencies

### nnUNet

`conda` environment with nnUNetV2 is required to run the `comparison_with_other_methods.sh` script. See installation instructions [here](https://github.com/ivadomed/utilities/blob/main/quick_start_guides/nnU-Net_quick_start_guide.md#installation).

## MONAI

### ANIMA

ANIMA is used to compute segmentation performance metrics. See installation instructions [here](https://github.com/ivadomed/utilities/blob/main/quick_start_guides/ANIMA_quick_start_guide.md).

### SCT

Follow installation instructions [here](https://github.com/spinalcordtoolbox/spinalcordtoolbox#installation).

## Running the `comparison_with_other_methods_{sc,lesion}.sh` script

This section explains how to run the script for the comparison of both SC and lesion methods.
Just run the file corresponding to `sc` or `lesion` for performing the comparison.

```bash
sct_run_batch -config config_{sc,lesion}_seed{XXX}.json
```

Example of the `config_sc_seed{XXX}.json` file:

```json
 {
  "path_data"   : "<PATH_TO_COMBINED_DATASET>_seed{XXX}",
  "path_output" : "<PATH_TO_COMBINED_DATASET>_2023-08-18",
  "script"      : "<PATH_TO_REPO>/model_seg_sci/baselines/comparison_with_other_methods_{sc/lesion}.sh",
  "jobs"        : 8, 
  "script_args" : "<PATH_TO_REPO>/model_seg_sci/packaging/run_inference_single_subject.py <PATH_TO_MODEL>/sci-multisite-model_seed{XXX} <PATH_TO_CONTRAST-AGNOSTIC_REPO>/monai/run_inference_single_image.py <PATH_TO_CONTRAST-AGNOSTIC_MODEL>"
 }
```

Example of the `config_lesion_seed{XXX}.json` file:

```json
 {
  "path_data"   : "<PATH_TO_COMBINED_DATASET>_seed{XXX}",
  "path_output" : "<PATH_TO_COMBINED_DATASET>_2023-08-18",
  "script"      : "<PATH_TO_REPO>/model_seg_sci/baselines/comparison_with_other_methods_{sc/lesion}.sh",
  "jobs"        : 8,
  "script_args" : "<PATH_TO_REPO>/model_seg_sci/packaging/run_inference_single_subject.py <PATH_TO_MODEL>/sci-multisite-model_seed{XXX}"
 }
```

ℹ️ `script_args` argument is used to pass arguments to the `comparison_with_other_methods_{sc,lesion}.sh` script. 
In this case, we pass the path to the `run_inference_single_subject.py` script and the path to the nnUNet model.

ℹ️ You can run the script across all train/test splits (i.e., seeds) by using the following command:

```commandline
for config_file in config_{sc/lesion}_seed*.json;do echo sct_run_batch -config $config_file;done
```

⚠️ Make sure that the input dataset (`path_data`) corresponds with the seed of the nnUNet model (`script_args`).

## Figures

To generate raincloud plots, run the `generate_figures.py` script:

```bash
python generate_figures.py -i sci-multisite-test-data_seed42_sc_inference_2023-09-11/results sci-multisite-test-data_seed123_sc_inference_2023-09-11/results ... -pred-type <sc/lesion>
```

- `-i` argument is for path(s) to the folder(s) (for different seeds) containing the xml files and execution_time.csv file generated by the `comparison_with_other_methods_{sc/lesion}.sh` script (you can provide multiple folders using a list separated by spaces)
- `-pred-type` is used to generate plots for either spinal cord segmentation `sc` or lesion segmentation `lesion`

## MRI-derived metrics

To compute MRI-derived metrics (lesion length, lesion volume, maximum axial damage ratio) from lesion and spinal cord predictions 
obtained using our 3D nnUNet model, run the `compute_lesion_metrics.py` script:

```bash
python compute_lesion_metrics.py -i sci-multisite-inference_sc_seed123_2023-09-08/data_processed sci-multisite-inference_sc_seed42_2023-09-06/data_processed ...
```

- `-i` argument is a space separated list of paths to the `data_processed` folders (one folder per seed; generated by the `comparison_with_other_methods_<sc/lesion>.sh` script) containing the spinal cord predictions. 
Note that the lesion predictions are fetched automatically from the corresponding `data_processed` folder.